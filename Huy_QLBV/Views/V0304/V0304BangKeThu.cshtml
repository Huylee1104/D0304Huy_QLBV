@{
    ViewData["NonSixOs"] = true;
}
@{
    Layout = null;
}
@{
    var jsonHTTT = Newtonsoft.Json.JsonConvert.SerializeObject(ViewBag.DSHTTT);
}
@{
    var jsonNhanVien = Newtonsoft.Json.JsonConvert.SerializeObject(ViewBag.DSNhanVien);
}
@model M0304.Models.PhanTrang.M0304PhanTrang
@{
    var toastType = TempData["ToastType"] as string;
    var toastMsgJson = System.Text.Json.JsonSerializer.Serialize(
        TempData["ToastMessage"]?.ToString() ?? string.Empty
    );
}
<!DOCTYPE html>
<html>
<head>
    <title>Index</title>
    <link rel="stylesheet" href="@Url.Content("~/dist/css/W0304/W0304_Report.css")" />
    <link rel="stylesheet" href="@Url.Content("~/dist/libs/bootstrap/dist/css/bootstrap.min.css")" /> <!---->
    <link rel="stylesheet" href="@Url.Content("~/dist/libs/bootstrap-datepicker/css/bootstrap-datepicker.min.css")" />
    <link rel="stylesheet" href="@Url.Content("~/dist/libs/bootstrap-icons/font/bootstrap-icons.css")" />
    <link rel="stylesheet" href="@Url.Content("~/dist/libs/toastr/toastr.min.css")" />

    <script src="~/dist/libs/jquery/dist/jquery.min.js" defer></script> <!---->
    <script src="~/dist/libs/bootstrap/dist/js/bootstrap.bundle.min.js" defer></script> <!---->
    <script src="~/dist/libs/bootstrap-datepicker/js/bootstrap-datepicker.min.js" defer></script>
    <script src="~/dist/libs/bootstrap-datepicker/locales/bootstrap-datepicker.vi.min.js" defer></script>
    <script src="~/dist/libs/toastr/toastr.min.js" defer></script>
    <script src="@Url.Content("~/dist/js/W0304/W0304combobox.js")" defer></script>
    <script src="@Url.Content("~/dist/js/W0304/BienChung.js")" defer></script>
    <script src="@Url.Content("~/dist/js/W0304/W0304_Report.js")" defer></script>

</head>
<body>
    <div class="card p-1">
        <div class="content">
            <div class="ngang">
                <div class="loc">
                    <div>
                        <form id="myForm" asp-action="Index" asp-controller="C0304BangKeThu" method="post" onsubmit="return false;">
                            @Html.AntiForgeryToken()
                            <div class="item">
                                <div class="row" style="padding:0; margin-right: 10px">
                                    <div style="width: 100%; padding:0; margin: 0 10px">
                                        <label class="form-label" >Giai đoạn</label>
                                        <select id="selectGiaiDoan" class="form-select">
                                            <option value="Nam" selected>Năm</option>
                                            <option value="Quy" >Quý</option>
                                            <option value="Thang" >Tháng</option>
                                            <option value="Ngay" >Ngày</option>
                                        </select>
                                    </div>
                                </div>
                                <div id="selectContainer"
                                     style="margin: 5px 0; display: flex; padding:0;justify-content: flex-start; align-items: flex-start; flex-wrap: wrap;">
                                </div>
                            </div>
                            <div class="item">
                                <label for="myDate" class="form-label">Từ ngày</label>
                                <div class="input-group date" id="datepicker">
                                    <input type="text" class="form-control" id="myDate" name="NgayBatDau"
                                           placeholder="dd-mm-yyyy" autocomplete="off" value="@ViewBag.NgayBatDau" data-ngay="@ViewBag.NgayBatDau" />
                                    <span class="input-group-text" id="datepicker-icon">
                                        <i class="bi bi-calendar-date"></i>
                                    </span>
                                </div>
                            </div>
                            <div class="item">
                                <label for="myDate2" class="form-label">Đến ngày</label>
                                <div class="input-group date" id="datepicker2">
                                    <input type="text" class="form-control" id="myDate2" name="NgayKetThuc"
                                           placeholder="dd-mm-yyyy" autocomplete="off" value="@ViewBag.NgayKetThuc" data-ngay2="@ViewBag.NgayKetThuc" />
                                    <span class="input-group-text" id="datepicker-icon2">
                                        <i class="bi bi-calendar-date"></i></span>
                                </div>
                            </div>
                            <div class="item">
                                <label for="NhanVien">Nhân viên</label>
                                <input type="text" id="comboBox2" name="tenNhanVien" data-value="@ViewBag.tenNhanVien">
                                <input type="hidden" id="IDNhanVien" name="IDNhanVien" data-value="@ViewBag.IDNhanVien" />
                                <div class="dropdownList" id="dropdownList2"></div>
                            </div>
                            <div class="item">
                                <label for="HTTT">Hình thức thanh toán</label>
                                <input type="text" id="comboBox" name="tenHTTT" data-value="@ViewBag.tenHTTT">
                                <input type="hidden" id="IDHTTT" name="IDHTTT" data-value="@ViewBag.IDHTTT" />
                                <div class="dropdownList" id="dropdownList"></div>
                            </div>
                            <input type="hidden" id="IDChiNhanh" name="IDChiNhanh" />
                            <div class="item">
                                <div class="button">
                                    <div>
                                        <button class="btn btn-primary" type="button" id="btnTaiDanhSach">Tải danh sách</button>
                                    </div>
                                    @{
                                        bool hasPermission = ViewBag.quyenVaiTro.Xuat;
                                        string pdfHref = hasPermission ? Url.Content("~/C0304BangKeThu/ExportPdf") : null;
                                        string excelHref = hasPermission ? Url.Content("~/C0304BangKeThu/ExportExcel") : null;
                                    }

                                    <div>
                                        <a href="@pdfHref"
                                           class="btn btn-danger @(hasPermission ? "" : "disabled")"
                                           @(hasPermission ? "" : "tabindex='-1' aria-disabled='true'")>
                                            PDF
                                        </a>
                                    </div>

                                    <div>
                                        <a href="@excelHref"
                                           class="btn btn-success @(hasPermission ? "" : "disabled")"
                                           @(hasPermission ? "" : "tabindex='-1' aria-disabled='true'")>
                                            Excel
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
                <div class="view">
                    <div id="bangKeThuContainer">
                        @await Html.PartialAsync("~/Views/V0304/V0304BangKeThuPartial.cshtml", Model)
                    </div>
                </div>
            </div>
        </div>
    </div>
    @if (!string.IsNullOrEmpty(toastType))
    {
        <script defer>
            document.addEventListener("DOMContentLoaded", function () {
                toastr.options = {
                    closeButton: true,
                    progressBar: true,
                    positionClass: "toast-bottom-right",
                    timeOut: 3500
                };

                var type = '@toastType';
                var msg = @Html.Raw(toastMsgJson);

                if (toastr[type]) toastr[type](msg);
                else toastr.info(msg);
            });
        </script>
    }

    <script defer>
        document.addEventListener("DOMContentLoaded", function () {
            var form = document.getElementById("myForm");
            var btnTaiDanhSach = document.getElementById("btnTaiDanhSach");
            var container = document.getElementById("bangKeThuContainer");

            btnTaiDanhSach.addEventListener("click", function () {
                submitForm(1);
            });

            form.addEventListener("submit", function (e) {
                e.preventDefault();
                submitForm(1);
            });

            container.addEventListener("click", function (e) {
                var link = e.target.closest(".page-link");
                if (!link) return;

                var li = link.closest(".page-item");
                if (li && li.classList.contains("disabled")) {
                    e.preventDefault();
                    return;
                }

                e.preventDefault();
                var page = parseInt(link.getAttribute("data-page"), 10);
                if (!isNaN(page)) {
                    submitForm(page);
                }
            });

            container.addEventListener("change", function (e) {
                if (e.target && e.target.id === "pageSize") {
                    submitForm(1); 
                }
            });

            function submitForm(page) {
                var formData = new FormData(form);

                formData.set("page", page);

                var pageSizeEl = container.querySelector("#pageSize");
                if (pageSizeEl && pageSizeEl.value) {
                    formData.set("pageSize", pageSizeEl.value);
                }

                var token = form.querySelector('input[name="__RequestVerificationToken"]').value;

                fetch(form.action, {
                    method: "POST",
                    body: new URLSearchParams(formData),
                    headers: {
                        "Content-Type": "application/x-www-form-urlencoded",
                        "RequestVerificationToken": token
                    }
                })
                .then(response => response.text())
                .then(html => {
                    container.innerHTML = html;
                })
                .catch(() => alert("Có lỗi khi tải danh sách!"));
            }
        });
    </script>

    <script>
        const provincesDataHTTT = @Html.Raw(jsonHTTT);
        const provincesDataNhanVien = @Html.Raw(jsonNhanVien);
        var isFirstLoadFromServer = @(ViewBag.IsFirstLoadFromServer.ToString().ToLower());
    </script>
</body>
</html>
